# Final Exam Reviewer - å¼€å‘è®°å½•

## ä¼šè¯æ—¥æœŸ: 2026-01-08

---

## é¡¹ç›®æ¦‚è¿°

Final Exam Reviewer æ˜¯ä¸€ä¸ª AI é©±åŠ¨çš„ PDF å­¦ä¹ åŠ©æ‰‹ï¼Œå¸®åŠ©å­¦ç”Ÿå¤ä¹ å’Œç†è§£å­¦ä¹ èµ„æ–™ã€‚

**æŠ€æœ¯æ ˆ:**
- åç«¯: Python FastAPI + SQLAlchemy + SQLite
- å‰ç«¯: Vanilla JavaScript + PDF.js
- AI: Gemini API (é€šè¿‡ OpenAI å…¼å®¹ä»£ç†)

---

## æœ¬æ¬¡ä¼šè¯å®Œæˆçš„å·¥ä½œ

### 1. ä¿®å¤äº†å¤šä¸ª Bug

#### 1.1 CORS é…ç½®é—®é¢˜
- **é—®é¢˜**: å‰ç«¯é€šè¿‡ `file://` åè®®è®¿é—®æ—¶æ— æ³•è°ƒç”¨ API
- **è§£å†³**: åœ¨ `backend/app/config.py` ä¸­æ·»åŠ  `"null"` åˆ° CORS å…è®¸çš„æº
```python
CORS_ORIGINS = [
    "http://localhost:3000",
    "http://localhost:3001",
    "http://localhost:8000",
    "http://127.0.0.1:8000",
    "null",  # å…è®¸ file:// åè®®è®¿é—®
]
```

#### 1.2 PDF åŠ è½½å¤±è´¥
- **é—®é¢˜**: å‰ç«¯æ— æ³•åŠ è½½ PDF æ–‡ä»¶
- **è§£å†³**:
  1. æ·»åŠ äº†æ–°çš„ API ç«¯ç‚¹ `/api/pdfs/{pdf_id}/file` è¿”å› PDF æ–‡ä»¶
  2. ä¿®æ”¹å‰ç«¯ä» `/uploads/` é™æ€è·¯å¾„æ”¹ä¸ºä½¿ç”¨ API ç«¯ç‚¹

**åç«¯ä¿®æ”¹** (`backend/app/routes/pdf_routes.py`):
```python
@router.get("/{pdf_id}/file")
async def get_pdf_file(pdf_id: int, db: Session = Depends(get_db)):
    """è·å–PDFæ–‡ä»¶"""
    # ... è¿”å› FileResponse
```

**å‰ç«¯ä¿®æ”¹** (`frontend/app.js`):
```javascript
const pdfUrl = `${API_BASE_URL}/pdfs/${pdfId}/file`;
```

#### 1.3 event.target undefined é”™è¯¯
- **é—®é¢˜**: `loadPDF` å‡½æ•°ä¸­ä½¿ç”¨äº† `event` å¯¹è±¡ä½†æ²¡æœ‰ä¼ é€’
- **è§£å†³**:
  1. ä¿®æ”¹ HTML ä¸­çš„è°ƒç”¨ä¸º `onclick="loadPDF(${pdf.id}, event)"`
  2. ä¿®æ”¹å‡½æ•°ç­¾åä¸º `loadPDF(pdfId, event)`
  3. æ·»åŠ å®‰å…¨æ£€æŸ¥å’Œå¤‡ç”¨æŸ¥æ‰¾æ–¹å¼

---

### 2. æ·»åŠ  Markdown æ¸²æŸ“æ”¯æŒ

**å¼•å…¥çš„åº“:**
- `marked.js` - Markdown è§£æ
- `highlight.js` - ä»£ç é«˜äº®

**ä¿®æ”¹çš„æ–‡ä»¶:**
- `frontend/index.html` - æ·»åŠ  CDN å¼•ç”¨
- `frontend/app.js` - æ·»åŠ  `renderMarkdown()` å’Œ `updateMessage()` å‡½æ•°
- `frontend/styles.css` - æ·»åŠ  Markdown æ ·å¼

**å…³é”®ä»£ç :**
```javascript
// Markdown é…ç½®
marked.setOptions({
    breaks: true,
    gfm: true,
    highlight: function(code, lang) {
        if (lang && hljs.getLanguage(lang)) {
            return hljs.highlight(code, { language: lang }).value;
        }
        return hljs.highlightAuto(code).value;
    }
});

function renderMarkdown(text) {
    try {
        return marked.parse(text);
    } catch (e) {
        return text;
    }
}
```

---

### 3. æ·»åŠ å¯è°ƒæ•´é¢æ¿å®½åº¦åŠŸèƒ½

**å®ç°æ–¹å¼:**
- åœ¨é¢æ¿ä¹‹é—´æ·»åŠ  `.resizer` åˆ†éš”æ¡
- é€šè¿‡é¼ æ ‡æ‹–æ‹½è°ƒæ•´ç›¸é‚»é¢æ¿å®½åº¦
- æ”¯æŒè§¦æ‘¸è®¾å¤‡

**å®½åº¦é™åˆ¶:**
- å·¦ä¾§è¾¹æ : 200px - 400px
- å³ä¾§èŠå¤©é¢æ¿: 280px - 600px

**å…³é”®ä»£ç ** (`frontend/app.js`):
```javascript
function setupResizers() {
    // ç›‘å¬ mousedown, mousemove, mouseup äº‹ä»¶
    // è®¡ç®—æ–°å®½åº¦å¹¶åº”ç”¨åˆ°é¢æ¿
}
```

---

### 4. ä¼˜åŒ– AI å›å¤æ ·å¼

**ä¿®æ”¹å†…å®¹:**
- ç§»é™¤æ¶ˆæ¯è¾¹æ¡†å’ŒèƒŒæ™¯è‰²
- AI å›å¤å æ®æ•´ä¸ªèŠå¤©åŒºåŸŸå®½åº¦
- è¡Œè·è®¾ä¸º 1.75ï¼Œæ›´æ˜“é˜…è¯»
- åº•éƒ¨æ·»åŠ æ·¡ç°è‰²åˆ†éš”çº¿

**CSS ä¿®æ”¹** (`frontend/styles.css`):
```css
.message.assistant {
    background: transparent;
    color: #1f2937;
    align-self: stretch;
    max-width: 100%;
    padding: 16px 4px;
    border-bottom: 1px solid #e5e7eb;
    border-radius: 0;
    line-height: 1.5;
}
```

---

### 5. å®Œå–„æ¡†é€‰æ–‡æœ¬åŠŸèƒ½

**æ–°å¢çš„å³é”®èœå•é€‰é¡¹:**

| åŠŸèƒ½ | è¯´æ˜ |
|------|------|
| ğŸ’¡ è§£é‡Šè¿™æ®µæ–‡å­— | è¯¦ç»†è§£é‡Šé€‰ä¸­å†…å®¹ |
| ğŸŒ ç¿»è¯‘æˆä¸­æ–‡ | ç¿»è¯‘é€‰ä¸­æ–‡æœ¬ |
| ğŸ“‹ æ€»ç»“è¦ç‚¹ | æå–æ ¸å¿ƒè¦ç‚¹ |
| ğŸ“– å®šä¹‰æœ¯è¯­ | è§£é‡Šæœ¯è¯­å®šä¹‰ |
| ğŸ“ ä¸¾ä¾‹è¯´æ˜ | ç”¨ä¾‹å­å¸®åŠ©ç†è§£ |
| â“ ç”Ÿæˆé—®é¢˜ | ç”Ÿæˆå¤ä¹ é—®é¢˜å’Œç­”æ¡ˆ |
| âœï¸ æ·»åŠ åˆ°è¾“å…¥æ¡† | å¯ç¼–è¾‘åå‘é€ |
| ğŸ“„ å¤åˆ¶æ–‡æœ¬ | å¤åˆ¶åˆ°å‰ªè´´æ¿ |

**UI æ”¹è¿›:**
- èœå•é¡¶éƒ¨æ˜¾ç¤ºé€‰ä¸­æ–‡æœ¬é¢„è§ˆ
- åŠŸèƒ½æŒ‰ç±»å‹åˆ†ç»„
- å›¾æ ‡+æ–‡å­—æ›´ç›´è§‚
- æ™ºèƒ½å®šä½ä¸è¶…å‡ºå±å¹•
- Toast æç¤ºåé¦ˆ

**æ–°å¢å‡½æ•°** (`frontend/app.js`):
- `defineTerms()` - å®šä¹‰æœ¯è¯­
- `giveExamples()` - ä¸¾ä¾‹è¯´æ˜
- `askQuestion()` - ç”Ÿæˆé—®é¢˜
- `addToInput()` - æ·»åŠ åˆ°è¾“å…¥æ¡†
- `copyText()` - å¤åˆ¶æ–‡æœ¬
- `showToast()` - Toast æç¤º

---

## å½“å‰é¡¹ç›®ç»“æ„

```
FInalExamReviewer/
â”œâ”€â”€ backend/
â”‚   â”œâ”€â”€ main.py                      # FastAPI å…¥å£
â”‚   â”œâ”€â”€ app/
â”‚   â”‚   â”œâ”€â”€ config.py                # é…ç½®ï¼ˆAPIå¯†é’¥ã€CORSç­‰ï¼‰
â”‚   â”‚   â”œâ”€â”€ database/
â”‚   â”‚   â”‚   â””â”€â”€ models.py            # SQLAlchemy æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”‚   â””â”€â”€ schemas.py           # Pydantic schemas
â”‚   â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â”‚   â”œâ”€â”€ pdf_routes.py        # PDF ç®¡ç† API
â”‚   â”‚   â”‚   â”œâ”€â”€ chat_routes.py       # èŠå¤© API
â”‚   â”‚   â”‚   â””â”€â”€ annotation_routes.py # æ ‡æ³¨ API
â”‚   â”‚   â””â”€â”€ services/
â”‚   â”‚       â”œâ”€â”€ gemini_service.py    # Gemini AI æœåŠ¡
â”‚   â”‚       â””â”€â”€ pdf_service.py       # PDF å¤„ç†æœåŠ¡
â”‚   â”œâ”€â”€ uploads/                     # PDF å­˜å‚¨ç›®å½•
â”‚   â””â”€â”€ database/                    # SQLite æ•°æ®åº“
â”œâ”€â”€ frontend/
â”‚   â”œâ”€â”€ index.html                   # ä¸»é¡µé¢
â”‚   â”œâ”€â”€ app.js                       # å‰ç«¯é€»è¾‘
â”‚   â””â”€â”€ styles.css                   # æ ·å¼
â”œâ”€â”€ memory/                          # å¼€å‘è®°å½•
â”œâ”€â”€ .env                             # ç¯å¢ƒå˜é‡
â”œâ”€â”€ start.bat                        # Windows å¯åŠ¨è„šæœ¬
â”œâ”€â”€ start.sh                         # Linux/Mac å¯åŠ¨è„šæœ¬
â””â”€â”€ CLAUDE.md                        # Claude Code æŒ‡å—
```

---

## Prompt é…ç½®ä½ç½®

æ‰€æœ‰ AI åŠŸèƒ½çš„ Prompt éƒ½åœ¨ `backend/app/services/gemini_service.py` ä¸­ï¼š

| æ–¹æ³• | åŠŸèƒ½ |
|------|------|
| `chat_with_pdf()` | æ™®é€šèŠå¤© |
| `explain_selected_text()` | è§£é‡Šæ–‡æœ¬ |
| `translate_text()` | ç¿»è¯‘æ–‡æœ¬ |
| `summarize_text()` | æ€»ç»“æ–‡æœ¬ |
| `generate_full_summary()` | å…¨æ–‡æ‘˜è¦ |

---

## å¯åŠ¨å‘½ä»¤

**Windows:**
```bash
start.bat
```

**Linux/Mac:**
```bash
chmod +x start.sh
./start.sh
```

**æ‰‹åŠ¨å¯åŠ¨:**
```bash
cd backend
pip install -r requirements.txt
python -m uvicorn main:app --reload --host 0.0.0.0 --port 8000
```

**è®¿é—®:**
- åç«¯ API: http://localhost:8000
- API æ–‡æ¡£: http://localhost:8000/docs
- å‰ç«¯: ç›´æ¥åœ¨æµè§ˆå™¨æ‰“å¼€ `frontend/index.html`

---

## å¾…å®Œæˆ/å¯æ”¹è¿›çš„åŠŸèƒ½

1. **PDF æ–‡æœ¬å±‚** - å·²æ·»åŠ  `text-layer` divï¼Œéœ€è¦å®ç° PDF.js æ–‡æœ¬å±‚æ¸²æŸ“ä»¥æ”¯æŒæ›´ç²¾ç¡®çš„æ–‡æœ¬é€‰æ‹©
2. **æ ‡æ³¨åŠŸèƒ½** - é«˜äº®å’Œç¬”è®°åŠŸèƒ½å°šæœªå®Œå…¨å®ç°
3. **å¤šè¯­è¨€ç¿»è¯‘** - ç›®å‰åªæ”¯æŒç¿»è¯‘æˆä¸­æ–‡
4. **å¯¹è¯å¯¼å‡º** - å¯¼å‡ºèŠå¤©è®°å½•
5. **PDF ç¼©ç•¥å›¾** - ä¾§è¾¹æ æ˜¾ç¤ºé¡µé¢ç¼©ç•¥å›¾
6. **é”®ç›˜å¿«æ·é”®** - æ·»åŠ å¸¸ç”¨æ“ä½œçš„å¿«æ·é”®

---

## æ³¨æ„äº‹é¡¹

1. æ¯æ¬¡ Gemini API è°ƒç”¨éƒ½ä¼šå‘é€å®Œæ•´çš„ PDFï¼ˆbase64 ç¼–ç ï¼‰
2. å¯¹è¯å†å²é™åˆ¶ä¸ºæœ€è¿‘ 5 æ¡æ¶ˆæ¯ï¼Œé˜²æ­¢ token æº¢å‡º
3. PDF æ‘˜è¦ä¼šç¼“å­˜åˆ°æ•°æ®åº“ï¼Œé¿å…é‡å¤ç”Ÿæˆ
4. å‰ç«¯é€šè¿‡ `file://` åè®®æ‰“å¼€ï¼Œéœ€è¦ CORS é…ç½®æ”¯æŒ `"null"` æº
