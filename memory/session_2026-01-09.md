# Final Exam Reviewer - 开发记录

## 会话日期: 2026-01-09

### 完成的任务

- [x] 添加 PDF 阅读模式切换（翻页/滚动）
- [x] 实现连续滚动模式渲染所有页面
- [x] 添加 PDF 文本层支持框选文字
- [x] 添加 KaTeX 库支持 LaTeX 公式渲染
- [x] 添加截图框选公式功能
- [x] 创建公式解释 API 端点 `/api/formula/explain`
- [x] 前端添加"解释公式"菜单项
- [x] 修改文本选择为自动弹出菜单（不需要右键）
- [x] 修复 SQLAlchemy 与 Python 3.13 兼容性问题
- [x] 创建启动/关闭服务器的批处理脚本

### 修改的文件

**后端：**
- `backend/main.py` - 添加 formula_routes 路由
- `backend/app/routes/formula_routes.py` - 新建，公式解释 API
- `backend/app/routes/__init__.py` - 新建，路由包初始化
- `backend/app/routes/chat_routes.py` - 添加 explain-formula 端点（备用）
- `backend/app/services/gemini_service.py` - 添加 explain_formula 方法

**前端：**
- `frontend/index.html` - 添加 KaTeX、PDF.js 文本层样式、截图遮罩、模式切换按钮
- `frontend/app.js` - 添加视图模式切换、文本层渲染、公式解释功能、截图功能、自动弹出菜单
- `frontend/styles.css` - 添加模式切换按钮、滚动模式、截图遮罩、公式样式

**脚本：**
- `clean_start.bat` - 清理缓存并启动服务器
- `start_server.bat` - 启动服务器
- `fix_and_start.bat` - 升级依赖并启动
- `test_formula.bat` - 测试公式路由导入
- `test_main.bat` - 测试主模块路由

### 遇到的问题和解决方案

1. **问题**: PDF 文本无法框选
   **解决**: 添加 PDF.js 文本层渲染，引入 pdf_viewer.min.css

2. **问题**: `/api/chat/explain-formula` 路由不出现在 API 文档
   **解决**: 创建独立的 `formula_routes.py`，使用 `/api/formula/explain` 路径

3. **问题**: SQLAlchemy 与 Python 3.13 不兼容
   **解决**: 运行 `pip install --upgrade sqlalchemy`

4. **问题**: 服务器热重载不生效
   **解决**: 创建 `clean_start.bat` 清理 `__pycache__` 后启动（不使用 --reload）

5. **问题**: CMD 终端输出乱码/截断
   **解决**: 创建批处理脚本写入文件查看结果

### 待完成的工作

- [ ] 测试公式识别功能是否正常工作
- [ ] 验证 LaTeX 渲染在聊天回复中正确显示
- [ ] 截图识别公式功能测试

### 重要代码片段

**公式解释 API (formula_routes.py):**
```python
@router.post("/explain")
async def explain_formula(request: dict, db: Session = Depends(get_db)):
    pdf_id = request.get("pdf_id")
    selected_text = request.get("selected_text")
    image_base64 = request.get("image_base64")
    page_number = request.get("page_number")

    explanation = gemini_service.explain_formula(
        pdf_path=pdf.file_path,
        selected_text=selected_text,
        image_base64=image_base64,
        page_num=page_number
    )
    return {"explanation": explanation}
```

**前端公式解释调用:**
```javascript
const response = await fetch(`${API_BASE_URL}/formula/explain`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
        pdf_id: currentPDF.id,
        selected_text: selectedText,
        page_number: currentPage
    })
});
```

### 常用命令

**启动服务器:**
```
cd E:\11Projects\FInalExamReviewer\backend
python -m uvicorn main:app --host 0.0.0.0 --port 8000
```

**或使用批处理:**
- `clean_start.bat` - 推荐，清理缓存后启动

**关闭服务器:**
- Ctrl+C 或 `taskkill /F /IM python.exe`

### 访问地址

- 前端: 直接打开 `frontend/index.html`
- API文档: http://localhost:8000/docs
- 健康检查: http://localhost:8000/health
